    If you haven't been following this series, I have been building a synthesizer in [Rust](https://www.rust-lang.org/) and [WebAssembly](https://webassembly.org/). The advantage of using WebAssembly is that I can take advantage of all of Rust's features while simultaneously avoiding the pitfalls of trying to use the operating system's complex libraries for playing audio.

## My Last Solution Was Not Ideal

[In the last post](https://dev.to/speratus/i-built-this-despite-a-flaw-in-rusts-webassembly-toolchain-38p2), I arrived at a working, but less than ideal solution for importing WebAssembly into an `AudioWorkletProcessor`. Even though I couldn't initially figure out how to import a WebAssembly module into a [worklet](https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API/Using_AudioWorklet) using `wasm-pack`, the process of doing so without `wasm-pack` enabled me to identify a potential solution that uses `wasm-pack`.

The next step was trying to implement it.

## A Better Idea

Once I understood the process of importing a WebAssembly module into a worklet, doing so using `wasm-pack` proved to be fairly simple. There are two general steps:

1. Compile the WebAssembly module using the `wasm-pack` `web` target. The `web` target creates JavaScript code that works without a bundler or Node.
2. Copy the JavaScript into the `AudioWorkletProcessor` file and adapt it to the context of `AudioWorkletGlobalScope`.

## Explanation

Since the `web` target is meant to work without the need for a bundler, the resulting JvaScript code can be copied into the `AudioWorkletProcessor` file and will only require minor changes. This approach is currently the best option because the `AudioWorkletGlobalScope` lacks the features required to import WebAssembly modules.

## Implementing the Solution

The first step is to build the Rust code with the `web`

```

wasm-pack build --target web

```

Enter fullscreen modeExit fullscreen mode

Once the code is compiled, I opened the JavaScript file named "\_bg.js". This file contains the WebAssembly bindings generated by `wasm-pack`. I copied everything in this file and pasted into my `AudioWorkletProcessor` class. This is the only way to get the JavaScript bindings into the `AudioWorkletGlobalScope`.

Next, I copied the `.wasm` file to a location where the browser could load it using `fetch()`. At the top of my worklet file, I had the following code which I knew would need to be adjusted.

```

// processor.js

let wasm;

const cachedTextDecoder = new TextDecoder('utf-8', { ignoreBOM: true, fatal: true });

cachedTextDecoder.decode();

let cachedUint8Memory0 = null;

function getUint8Memory0() {
    if (cachedUint8Memory0 === null || cachedUint8Memory0.byteLength === 0) {
        cachedUint8Memory0 = new Uint8Array(wasm.memory.buffer);
    }
    return cachedUint8Memory0;
}

// wasm-pack generated code ...

export { initSync }
export default init;

class WebSynthProcessor extends AudioWorkletProcessor {
    // ...
}

```

Enter fullscreen modeExit fullscreen mode

I replaced this code with the following:

```

// processor.js

let wasm;

let cachedTextDecoder;

// decode call will be made later

let cachedUint8Memory0 = null;

function getUint8Memory0() {
    if (cachedUint8Memory0 === null || cachedUint8Memory0.byteLength === 0) {
        cachedUint8Memory0 = new Uint8Array(wasm.memory.buffer);
    }
    return cachedUint8Memory0;
}

// wasm-pack generated JavaScript

// Notice, I removed the exports.

class WebSynthProcessor extends AudioWorkletProcessor {
    // ...
}

```

Enter fullscreen modeExit fullscreen mode

An Instance of `TextDecoder` class needs to be available in the `AudioWorkletGlobalScope`, but the audio worklet scope does not allow the `TextDecoder` class's constructor to be used. I used the `AudioWorkletProcessor`'s `MessagePort` to give the audio worklet a `TextDecoder` instance.

### Setting Up the WebAssembly Module

In order to pass the WebAssembly module to the `AudioWorkletProcessor`, I knew I would need to call `WebAssembly.compile()` in the main thread and pass it to my audio processor. To do this, I needed to call both `fetch()` and `WebAssembly.compileStreaming()` like this:

```

// index.js

// We will need the worklet node later.
let node = new AudioWorkletNode(context, 'web-synth-proto');

WebAssembly.compileStreaming(fetch('/path/to/library.wasm')).then(module => {
    // Pass the module to the AudioWorkletProcessor
});

```

Enter fullscreen modeExit fullscreen mode

I originally did this in an `async` function so that I could use `await` to get the return value directly. Here, I'm using a callback with a promise because this pattern is more common.

Once I had a `WebAssembly` module instance, I passed it to the `AudioWorkletProcessor` using the `MessagePort` instance like this:

```

// index.js

WebAssembly.compileStreaming(fetch('/path/to/library.wasm')).then(module => {
    // Now that the module has been created, it can be passed to the processor.
    node.port.postMessage({type: 'init-wasm', wasmData: module});
});

```

Enter fullscreen modeExit fullscreen mode

### Using the Module in the AudioWorkletProcessor

To use the WebAssembly module, it needed to be instantiated from inside the audio worklet thread. The first step in this process was to set up a message listener for for the `MessagePort` instance. I did this in the constructor of the `AudioWorkletProcessor`.

```

// processor.js

class WebSynthProcessor extends AudioWorkletProcessor {
    constructor(options) {
        super(options);

        this.port.onmessage = event => this.onmessage(event.data);

    }

    onmessage(data) {
        // Check to make sure the message we receive is the correct type.
        if (data.type === 'init-wasm') {
            // Finish instantiating the WebAssembly module
        }
    }
}

```

Enter fullscreen modeExit fullscreen mode

Now that there is an `onmessage` listener for the `MessagePort`, the worklet can listen for the message sent by the main thread.

```

// processor.js

class WebSynthProcessor extends AudioWorkletProcessor {
    constructor(options) {
        super(options);

        this.port.onmessage = event => this.onmessage(event.data);

    }

    onmessage(data) {
        // Check to make sure the message we receive is the correct type.
        if (data.type === 'init-wasm') {
            cachedTextDecoder = data.decoder;

            // Load returns a promise
            load(data.wasmData, getImports()).then(mod => {
                // Once the WebAssembly module has been instantiated, it needs to be finalized
                // so that it can be accessed later.
                finalizeInit(mod.instance, mod.module);
            });
        }
    }
}

```

Enter fullscreen modeExit fullscreen mode

Once the worklet receives the WebAssembly module from the main thread, it needs to call the `load()` function copied from the wasm-pack output so that the WebAssembly module can be properly instantiated. Finally, the audio processor thread needs to call the `finalizeInit()` function to ensure that it can continue to access the WebAssembly code.

Now that all the setup is complete, the audio thread can use the `SineOsc` struct by calling the JavaScript wrapper functions.

Here is how I setup the oscillator:

```

// processor.js

class WebSynthProcessor extends AudioWorkletProcessor {
    constructor(options) {
        super(options);

        this.port.onmessage = event => this.onmessage(event.data);

    }

    onmessage(data) {
        // Check to make sure the message we receive is the correct type.
        if (data.type === 'init-wasm') {
            cachedTextDecoder = data.decoder;

            // Load returns a promise
            load(data.wasmData, getImports()).then(mod => {
                // Once the WebAssembly module has been instantiated, it needs to be finalized
                // so that it can be accessed later.
                finalizeInit(mod.instance, mod.module);

                // Create the oscillator instance.
                this.osc = SineOsc.new(sampleRate);
            });
        }
    }
}

```

Enter fullscreen modeExit fullscreen mode

Now that the audio thread has created an oscillator, that oscillator can be called to do the actual sound generation.

```

// processor.js

class WebSynthProcessor extends AudioWorkletProcessor {

    // ...

    process(inputs, outputs, parameters) {
        if (typeof this.osc !== 'undefined' && this.osc !== null) {
            // Get the first output channel.
            let output = outputs[0];

            output.forEach(channel => {
                // populate the channel's buffer with samples from the WebAssembly code.
                for (let i = 0; i < channel.length; i++) {
                    // Remember the first argument for the sample method is the pitch we want to
                    // synthesize and the second argument is the volume.
                    let sample = this.osc.sample(440, 0.5);

                    channel[i] = sample;
                }
            });
        } else {
            console.log('wasm not instantiated yet');
        }
        return true;
    }
}

```

Enter fullscreen modeExit fullscreen mode

## What Next?

At this point, I have demonstrated how to adapt `wasm-pack`'s output so that it can be used in an `AudioWorkletProcessor` file. The next step is to start building out the features necessary for a usable synthesizer.

> _If you want to read more about this project, feel free to follow me or read my other posts in this series._

_Introduction to the series:_

[![speratus](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Fuser%2Fprofile_image%2F393577%2F6b04ceaa-83fa-4388-ad69-0cd2599e34df.png)](/speratus)[**Building a Browser-Based Synthesizer Using Rust and WebAssembly**  **Andrew Luchuk ãƒ» Apr 19 '23**\\
\\
#rust#javascript#webassembly](/speratus/building-a-browser-based-synthesizer-using-rust-and-webassembly-3kpl)

_Source code for this prototype:_

## ![GitHub logo](https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev.to%2Fassets%2Fgithub-logo-5a155e1f9a670af7944dd5e12375bc76ed542ea80224905ecaf878b9157cdefc.svg)[speratus](https://github.com/speratus) / [web-synth-proto2](https://github.com/speratus/web-synth-proto2)

### Web Synthesizer prototype 2

# Websynth Prototype

This project is a proof of concept for using Rust to generate samples for a Web Audio API backed synthesizer.

You can read an introductiont to the project on [dev.to](https://dev.to/speratus/building-a-browser-based-synthesizer-using-rust-and-webassembly-3kpl).

## Dependencies

To build this project you will need the following:

- [Rust](https://www.rust-lang.org/)
- [wasm-pack](https://rustwasm.github.io/wasm-pack/installer/)

## Building

To build the Rust components of this project, simply run

```
wasm-pack build --target web
```

Enter fullscreen modeExit fullscreen mode

See [this post](https://dev.to/speratus/building-a-browser-based-synthesizer-using-rust-and-webassembly-3kpl) for details regarding how to integrate it into a web page.

## Running

This project can be run using Visual Studio Code's "Live Server" extension. Simply install it, and follow the instructions to go live.
Once you have the server running, navigate to the "www" directory to see the web page.

If you don't have Visual Studio Code, you should also be able to open `index.html` in the `www` directory in any modern web browser
Although I haven't thoroughly tested this method, I don't think you will runâ€¦

[View on GitHub](https://github.com/speratus/web-synth-proto2)

ðŸ‘‹ Before you go

Dropdown menu

- [What's a billboard?](/billboards)
- [Manage preferences](/settings/customization#sponsors)

* * *

- [Report billboard](/report-abuse?billboard=104704)

Do your career a favor. **Join DEV.**

It takes **_one minute_** and is worth it for your career.

[Get started](https://dev.to/enter?state=new-user)

![pic](https://media2.dev.to/dynamic/image/width=256,height=,fit=scale-down,gravity=auto,format=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2F8j7kvp660rqzt99zui8e.png)

[Create template](/settings/response-templates)

Templates let you quickly answer FAQs or store snippets for re-use.

SubmitPreview [Dismiss](/404.html)

Are you sure you want to hide this comment? It will become hidden in your post, but will still be visible via the comment's permalink.


Hide child comments as well

Confirm


For further actions, you may consider blocking this person and/or [reporting abuse](/report-abuse)

[![profile](https://media2.dev.to/dynamic/image/width=64,height=64,fit=cover,gravity=auto,format=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Forganization%2Fprofile_image%2F123%2F38b10714-65da-4f1d-88ae-e9b28c1d7a5e.png)\\
Heroku](/heroku) Promoted

Dropdown menu

- [What's a billboard?](/billboards)
- [Manage preferences](/settings/customization#sponsors)

* * *

- [Report billboard](/report-abuse?billboard=152190)

[![Heroku](https://media2.dev.to/dynamic/image/width=775%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fi.imgur.com%2F9upiy9g.png)](https://www.heroku.com/platform?utm_source=devto&utm_medium=paid&utm_campaign=devto_and_heroku&bb=152190)

## [This site is powered by Heroku](https://www.heroku.com/platform?utm_source=devto&utm_medium=paid&utm_campaign=devto_and_heroku&bb=152190)

Heroku was created by developers, for developers. Get started today and find out why Heroku has been the platform of choice for brands like DEV for over a decade.

[Sign Up](https://www.heroku.com/platform?utm_source=devto&utm_medium=paid&utm_campaign=devto_and_heroku&bb=152190)

## Read next

[![gameon_gameover_8f18dbb85 profile image](https://media2.dev.to/dynamic/image/width=100,height=100,fit=cover,gravity=auto,format=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Fuser%2Fprofile_image%2F2159911%2Fdcc4417f-0e39-4aa6-974b-662ae8e2829f.png)\\
\\
**Top 45+ Active directory interview questions and answers for experienced**\\
\\
gameon gameover - Oct 18](/gameon_gameover_8f18dbb85/top-45-active-directory-interview-questions-and-answers-for-experienced-39a9) [![arkadiptakundu profile image](https://media2.dev.to/dynamic/image/width=100,height=100,fit=cover,gravity=auto,format=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Fuser%2Fprofile_image%2F2004637%2F2f2eea46-9d42-4642-ac26-917cfb0d299e.jpg)\\
\\
**What is the Difference Between Expressions and Statements in JavaScript?**\\
\\
Arkadipta kundu - Oct 21](/arkadiptakundu/what-is-the-difference-between-expressions-and-statements-in-javascript-34o0) [![ajmal_hasan profile image](https://media2.dev.to/dynamic/image/width=100,height=100,fit=cover,gravity=auto,format=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Fuser%2Fprofile_image%2F376439%2Fbaab1815-28a3-4b78-906b-ffc9be6e126b.jpg)\\
\\
**Promises in JavaScript and React Native: Creation, Usage, and Common Scenarios**\\
\\
Ajmal Hasan - Nov 9](/ajmal_hasan/promises-in-javascript-and-react-native-creation-usage-and-common-scenarios-lko) [![kvetoslavnovak profile image](https://media2.dev.to/dynamic/image/width=100,height=100,fit=cover,gravity=auto,format=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Fuser%2Fprofile_image%2F544080%2Fdced91ad-b5ad-422f-80c2-86461766f76a.jpg)\\
\\
**"Helper" Varaibles in Svelte 5**\\
\\
kvetoslavnovak - Nov 8](/kvetoslavnovak/helper-varaibles-in-svelte-5-5cni)

ðŸ‘‹ Kindness is contagious

Dropdown menu

- [What's a billboard?](/billboards)
- [Manage preferences](/settings/customization#sponsors)

* * *

- [Report billboard](/report-abuse?billboard=124822)

Close

Engage with a sea of insights in this enlightening article, highly esteemed within the encouraging DEV Community. **Programmers of every skill level** are invited to participate and enrich our shared knowledge.

A simple "thank you" can uplift someone's spirits. Express your appreciation in the comments section!

On DEV, **sharing knowledge smooths our journey** and strengthens our community bonds. Found this useful? A brief thank you to the author can mean a lot.

### [Okay](https://dev.to/enter?state=new-user&bb=124822)

![DEV Community](https://media2.dev.to/dynamic/image/width=190,height=,fit=scale-down,gravity=auto,format=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2F8j7kvp660rqzt99zui8e.png)

We're a place where coders share, stay up-to-date and grow their careers.


[Log in](/enter) [Create account](/enter?state=new-user)

![](https://assets.dev.to/assets/sparkle-heart-5f9bee3767e18deb1bb725290cb151c25234768a0e9a2bd39370c382d02920cf.svg)![](https://assets.dev.to/assets/multi-unicorn-b44d6f8c23cdd00964192bedc38af3e82463978aa611b4365bd33a0f1f4f3e97.svg)![](https://assets.dev.to/assets/exploding-head-daceb38d627e6ae9b730f36a1e390fca556a4289d5a41abb2c35068ad3e2c4b5.svg)![](https://assets.dev.to/assets/raised-hands-74b2099fd66a39f2d7eed9305ee0f4553df0eb7b4f11b01b6b1b499973048fe5.svg)![](https://assets.dev.to/assets/fire-f60e7a582391810302117f987b22a8ef04a2fe0df7e3258a5f49332df1cec71e.svg)